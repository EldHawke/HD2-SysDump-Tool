name: Build and Release

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: "6.0.x"

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Find built EXE
        id: findexe
        shell: pwsh
        run: |
          $exe = Get-ChildItem -Path "HD2-TS-Tool/bin/Release" -Filter "HD2-TS-Tool.exe" -Recurse | Select-Object -First 1
          if (-not $exe) { throw "HD2-TS-Tool.exe not found in bin/Release" }
          $relPath = $exe.FullName.Substring((Get-Location).Path.Length + 1) -replace '\\','/'
          Write-Host "Found EXE: $relPath"
          echo "EXE_PATH=$relPath" >> $env:GITHUB_ENV

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.EXE_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}